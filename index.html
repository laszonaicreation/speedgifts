<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Gifts | Premium Boutique</title>
    
    <!-- Fonts Import -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,700;0,800;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ============================================================
           MAIN DESIGN CONFIGURATION (EDIT HERE)
           Ivide maattangal varuthiyaal website mothamaayi maarum
           ============================================================
        */
        :root { 
            /* GLOBAL COLORS (Website poornamaayi maaraan) */
            --website-bg: #ffffff;
            --text-main: #111111;
            --text-muted: #999999;
            --accent-black: #000000;
            --border-light: #f5f5f5;

            /* ------------------------------------------------------------
               DETAIL VIEW PAGE SETTINGS (Special for Product Detail)
               Ivide maattangal varuthiyaal Detail Page mathram maarum
               ------------------------------------------------------------
            */
            --detail-page-bg: #ffffff;      /* Detail view background nira */
            
            /* Name Settings in Detail View */
            --detail-name-font: 'Inter', sans-serif; 
            --detail-name-color: #111111;   /* Product name nira */
            --detail-name-weight: 600;      /* Aksharaṅṅaḷude thickness */
            --detail-name-size-mob: 1.75rem; /* Mobile name size */
            --detail-name-size-desk: 3rem;   /* Desktop name size */

            /* Price Settings in Detail View */
            --detail-price-font: 'Inter', sans-serif;
            --detail-price-color: #111111;  /* Price nira */
            --detail-price-size: 1.5rem;    /* Price size */

            /* Labels (Item name:, Price:, Description:) */
            --detail-label-color: #b0b0b0;  /* Standard grey for labels */
            --detail-label-font-size: 10px;

            /* Description Text */
            --detail-desc-color: #555555;   /* Description text nira */
            --detail-desc-size: 14px;       /* Description text size */
            
            /* ------------------------------------------------------------ */
            
            --font-main: 'Inter', sans-serif; 
        }
        
        body { 
            font-family: var(--font-main); 
            background-color: var(--website-bg); 
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            letter-spacing: -0.02em;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }

        /* DETAIL VIEW CSS CLASSES */
        .detail-view-container { 
            background-color: var(--detail-page-bg); 
            text-align: left; 
        }
        
        .detail-product-name { 
            font-family: var(--detail-name-font); 
            color: var(--detail-name-color); 
            font-weight: var(--detail-name-weight); 
            font-size: var(--detail-name-size-mob);
            line-height: 1.2; 
        }
        @media (min-width: 768px) {
            .detail-product-name { font-size: var(--detail-name-size-desk); }
        }

        .detail-price-text { 
            font-family: var(--detail-price-font); 
            color: var(--detail-price-color); 
            font-size: var(--detail-price-size);
            font-weight: 700; 
        }

        .detail-label { 
            font-size: var(--detail-label-font-size); 
            font-weight: 700; 
            letter-spacing: 0.05em; 
            color: var(--detail-label-color); 
            margin-bottom: 4px; 
            display: block; 
            text-transform: uppercase; 
        }

        .detail-description-text { 
            color: var(--detail-desc-color); 
            font-size: var(--detail-desc-size); 
            line-height: 1.6; 
        }

        /* CUSTOMER VIEW - Home Card Styling */
        .product-card h3 { font-size: 13px; font-weight: 600; }
        .price-tag { font-size: 11px; font-weight: 700; color: var(--text-muted); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .brand-logo { font-weight: 900; letter-spacing: 0.25em; font-size: 15px; }
        @media (min-width: 768px) { .brand-logo { font-size: 20px; } }

        .category-item { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; cursor: pointer; width: 78px; transition: 0.3s ease; }
        .category-circle { width: 58px; height: 58px; border-radius: 50%; border: 1px solid var(--border-light); padding: 3px; background: #fff; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .active .category-circle { border-color: var(--accent-black); transform: scale(1.1); }
        .category-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 10px; color: var(--text-muted); text-align: center; }

        .img-container { aspect-ratio: 3/4; overflow: hidden; background: #fafafa; border-radius: 12px; border: 1px solid var(--border-light); position: relative; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 1.2s ease; }

        .select-btn { position: absolute; top: 8px; right: 8px; width: 22px; height: 22px; background: rgba(255,255,255,0.95); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 20; border: 1px solid #eee; transition: 0.3s; }
        .selected .select-btn { background: var(--accent-black); color: #fff; border-color: var(--accent-black); }

        /* SELECTION BAR - Compact Centered */
        #selection-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-black);
            color: #fff;
            padding: 8px 12px;
            border-radius: 100px;
            display: none; 
            align-items: center;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            width: auto;
            min-width: 220px;
            max-width: 94vw;
            backdrop-filter: blur(15px);
        }

        @keyframes slideUpCenter {
            from { opacity: 0; transform: translateX(-50%) translateY(15px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .animate-selection { animation: slideUpCenter 0.4s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }

        .selection-count { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; padding-left: 6px; white-space: nowrap; }
        #selection-bar button { font-size: 8px; padding: 5px 12px; font-weight: 700; letter-spacing: 0.03em; }

        .thumb-grid { display: flex; gap: 8px; margin-top: 12px; }
        .thumb-box { width: 50px; height: 50px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border-light); cursor: pointer; transition: 0.3s; }
        .thumb-box.active { border-color: var(--accent-black); border-width: 1.5px; }

        .admin-input { width: 100%; padding: 1.1rem; background: #f9f9f9; border: 1px solid transparent; border-radius: 12px; font-size: 14px; transition: 0.3s; }
        .admin-input:focus { background: #fff; border-color: var(--accent-black); outline: none; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeInUp 0.6s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        #toast { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); z-index: 10001; display: none; }
    </style>
</head>
<body class="selection:bg-black selection:text-white">

    <div id="toast" class="bg-black text-white px-8 py-4 rounded-xl shadow-2xl text-[10px] font-black tracking-widest uppercase"></div>

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-gray-50">
        <div class="max-w-7xl mx-auto px-5 h-16 md:h-20 flex items-center justify-between">
            <div class="w-1/4">
                <button id="admin-entry-btn" class="hidden bg-black text-white px-4 py-2 rounded-full text-[8px] font-bold tracking-widest uppercase" onclick="showAdminPanel()">
                    Dashboard
                </button>
            </div>
            <div class="flex-1 text-center">
                <h1 class="brand-logo cursor-pointer select-none uppercase truncate leading-none" id="main-logo" onclick="handleLogoClick()">
                    SPEED GIFTS
                </h1>
            </div>
            <div class="w-1/4 flex justify-end">
                <span class="text-[9px] font-black text-gray-200 tracking-widest hidden md:block">BOUTIQUE</span>
            </div>
        </div>
    </nav>

    <main id="app" class="max-w-7xl mx-auto px-5 pt-4 pb-48 min-h-screen">
        <div id="loader" class="flex flex-col items-center justify-center py-64">
            <div class="w-6 h-6 border-2 border-gray-100 border-t-black rounded-full animate-spin"></div>
        </div>
    </main>

    <!-- Templates -->
    <div id="home-view-template" class="hidden">
        <div id="selection-header" class="hidden mb-10 fade-in">
            <div class="flex flex-col gap-4 border-b border-gray-100 pb-8">
                <div class="space-y-1">
                    <h2 class="text-xl font-black tracking-tight uppercase">Picked for you</h2>
                    <p class="text-[12px] text-gray-400">Exclusive items curated for your boutique experience.</p>
                </div>
                <button onclick="goBackToHome()" class="text-[9px] font-bold uppercase tracking-widest px-6 py-3 bg-black text-white rounded-full shadow-lg self-start">View All Products</button>
            </div>
        </div>
        <div id="category-row" class="no-scrollbar flex gap-4 overflow-x-auto py-8 items-center border-b border-gray-50 mb-10 px-1"></div>
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-12 md:gap-x-8 md:gap-y-20"></div>
    </div>

    <div id="selection-bar">
        <span class="selection-count" id="selected-count">0 items</span>
        <div class="h-4 w-px bg-white/20"></div>
        <div class="flex gap-2">
            <button onclick="shareSelection()" class="bg-white/10 text-white px-3 py-2 rounded-full border border-white/10 whitespace-nowrap">Copy link</button>
            <button onclick="sendBulkInquiry()" class="bg-white text-black px-3 py-2 rounded-full shadow-lg">WhatsApp</button>
        </div>
        <button onclick="clearSelection()" class="text-white opacity-40 hover:opacity-100 text-sm ml-1 pr-1"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden fixed inset-0 z-[60] bg-white overflow-y-auto">
        <div class="max-w-6xl mx-auto px-8 py-20">
            <div class="flex justify-between items-center mb-16">
                <div><h2 class="text-3xl font-black tracking-tight uppercase">Workspace</h2><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Cloud Inventory Manager</p></div>
                <button onclick="hideAdminPanel()" class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-50 text-gray-400 hover:text-black">✕</button>
            </div>
            
            <div class="flex p-1 bg-gray-50 rounded-2xl mb-12 max-w-sm border border-gray-100 shadow-inner">
                <button onclick="switchAdminTab('products')" id="tab-p" class="flex-1 py-4 rounded-xl text-[10px] font-bold uppercase transition-all bg-white shadow-xl">Products</button>
                <button onclick="switchAdminTab('categories')" id="tab-c" class="flex-1 py-4 rounded-xl text-[10px] font-bold uppercase text-gray-400">Categories</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
                <div class="lg:col-span-5">
                    <div id="admin-product-section" class="fade-in">
                        <div class="bg-gray-50 p-8 rounded-[2rem] border border-gray-100 space-y-4 shadow-sm">
                            <h3 class="text-[11px] font-black uppercase tracking-widest">Product Details</h3>
                            <input type="hidden" id="edit-id">
                            <input type="text" id="p-name" class="admin-input" placeholder="Item Name">
                            <input type="text" id="p-price" class="admin-input" placeholder="Price (AED 50)">
                            <select id="p-cat-id" class="admin-input cursor-pointer"></select>
                            <div class="bg-white/60 p-4 rounded-xl border border-gray-100 space-y-4">
                                <input type="text" id="p-img" class="w-full bg-transparent outline-none text-sm font-semibold" value="img/" placeholder="Image Path 1">
                                <input type="text" id="p-img2" class="w-full bg-transparent outline-none text-sm font-semibold" value="img/" placeholder="Image Path 2">
                            </div>
                            <textarea id="p-desc" rows="4" class="admin-input" placeholder="Product description..."></textarea>
                            <button onclick="saveProduct()" id="p-save-btn" class="w-full bg-black text-white py-5 rounded-2xl font-bold text-[11px] uppercase tracking-widest shadow-2 mt-4">Sync Product</button>
                        </div>
                    </div>
                    <div id="admin-category-section" class="hidden fade-in">
                        <div class="bg-gray-50 p-8 rounded-[2rem] border border-gray-100 space-y-4 shadow-sm">
                            <h3 class="text-[11px] font-black uppercase tracking-widest">New Category</h3>
                            <input type="text" id="c-name" class="admin-input" placeholder="Category Title">
                            <input type="text" id="c-img" class="admin-input" value="img/" placeholder="Icon Path">
                            <button onclick="saveCategory()" class="w-full bg-black text-white py-5 rounded-2xl font-bold text-[11px] uppercase tracking-widest mt-4">Sync Category</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-7">
                    <h4 id="list-title" class="text-[11px] font-bold uppercase tracking-widest text-gray-300 mb-8 italic">Live Inventory</h4>
                    <div id="admin-product-list" class="space-y-4 fade-in"></div>
                    <div id="admin-category-list" class="hidden space-y-4 fade-in"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzAGimDQCeuV4oMEQhhUBH8tbsQjBf9hc",
            authDomain: "cataloguedata-9b2be.firebaseapp.com",
            projectId: "cataloguedata-9b2be",
            storageBucket: "cataloguedata-9b2be.firebasestorage.app",
            messagingSenderId: "191169887154",
            appId: "1:191169887154:web:08319d5f3898ed22db02ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        const prodCol = collection(db, 'artifacts', appId, 'public', 'data', 'products');
        const catCol = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
        const shareCol = collection(db, 'artifacts', appId, 'public', 'data', 'selections');

        let DATA = { p: [], c: [] };
        let state = { filter: 'all', user: null, selected: [], selectionId: null };
        let clicks = 0, lastClickTime = 0;

        const startSync = async () => {
            try { await signInAnonymously(auth); } 
            catch (err) { console.error(err); }
        };

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            if (u) refreshData();
        });

        async function refreshData() {
            try {
                // Always fetch if DATA is empty, otherwise skip unless forced
                if (DATA.p.length === 0) {
                    const [pSnap, cSnap] = await Promise.all([getDocs(prodCol), getDocs(catCol)]);
                    DATA.p = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    DATA.c = cSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const shareId = urlParams.get('s');
                const prodId = urlParams.get('p');

                // Check if admin is open to avoid jumping views
                const isAdminOpen = !document.getElementById('admin-panel').classList.contains('hidden');

                if (!isAdminOpen) {
                    if (prodId && DATA.p.length > 0) {
                        viewDetail(prodId);
                    } else if (shareId) {
                        const selDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'selections', shareId));
                        if (selDoc.exists()) {
                            state.selectionId = shareId;
                            state.selected = selDoc.data().ids;
                            renderHome();
                        }
                    } else {
                        renderHome();
                    }
                } else {
                    // Just refresh background if on home
                    const appArea = document.getElementById('app');
                    if (appArea.querySelector('#product-grid')) {
                        renderHome();
                    }
                }
                
                populateCatSelect();
                renderAdminUI(); // <--- SPOT UPDATE: Updates dashboard list immediately
                
                const loader = document.getElementById('loader');
                if (loader) loader.style.display = 'none';
            } catch (err) { console.error(err); showToast("Sync Error"); }
        }

        window.handleLogoClick = () => {
            const now = Date.now();
            if (now - lastClickTime > 2500) clicks = 0;
            clicks++; lastClickTime = now;
            if (clicks >= 5) {
                const btn = document.getElementById('admin-entry-btn');
                if (btn) { btn.classList.remove('hidden'); showToast("Dashboard Unlocked"); }
                clicks = 0;
            }
            goBackToHome();
        };

        window.goBackToHome = () => {
            if (window.location.search) {
                window.history.pushState({}, '', window.location.pathname);
                state.selectionId = null;
            }
            renderHome();
        };

        function renderHome() {
            const appMain = document.getElementById('app');
            const template = document.getElementById('home-view-template');
            if (!appMain || !template) return;
            appMain.innerHTML = template.innerHTML;

            const catRow = document.getElementById('category-row');
            const grid = document.getElementById('product-grid');
            const selectionHeader = document.getElementById('selection-header');

            if (state.selectionId) {
                if (selectionHeader) selectionHeader.classList.remove('hidden');
                if (catRow) catRow.classList.add('hidden');
            } else {
                let cHtml = `<div class="category-item ${state.filter === 'all' ? 'active' : ''}" onclick="applyFilter('all')"><div class="category-circle flex items-center justify-center bg-gray-50 text-[9px] font-black text-gray-300">All</div><p class="category-label">Explore</p></div>`;
                DATA.c.forEach(c => {
                    cHtml += `<div class="category-item ${state.filter === c.id ? 'active' : ''}" onclick="applyFilter('${c.id}')"><div class="category-circle overflow-hidden"><img src="${c.img}" class="w-full h-full rounded-full object-cover" onerror="this.src='https://placehold.co/100x100?text=Gift'"></div><p class="category-label truncate max-w-[70px]">${c.name}</p></div>`;
                });
                if (catRow) catRow.innerHTML = cHtml;
            }

            let filtered = state.selectionId ? DATA.p.filter(p => state.selected.includes(p.id)) : 
                          (state.filter !== 'all' ? DATA.p.filter(p => p.catId === state.filter) : DATA.p);

            if (grid) {
                grid.innerHTML = filtered.map(p => `<div class="product-card group fade-in ${state.selected.includes(p.id) ? 'selected' : ''}" onclick="viewDetail('${p.id}')">${!state.selectionId ? `<div class="select-btn shadow-sm" onclick="toggleSelect(event, '${p.id}')"><i class="fa-solid fa-check text-[10px]"></i></div>` : ''}<div class="img-container mb-4 shadow-sm"><img src="${p.img}" loading="lazy"></div><div class="px-1 text-left"><h3 class="capitalize truncate leading-none">${p.name}</h3><p class="price-tag mt-2">${p.price} AED</p></div></div>`).join('') || `<p class="col-span-full text-center py-40 text-gray-300 italic text-[11px]">No items found.</p>`;
            }
            updateSelectionBar();
            window.scrollTo({top: 0});
        }

        window.viewDetail = (id) => {
            const p = DATA.p.find(x => x.id === id);
            if (!p) return;
            const appMain = document.getElementById('app');
            appMain.innerHTML = `<div class="max-w-5xl mx-auto py-8 fade-in px-4 pb-48 detail-view-container text-left"><button onclick="goBackToHome()" class="mb-10 text-[10px] font-bold text-gray-400 flex items-center gap-2 uppercase tracking-widest hover:text-black transition-all"><i class="fa-solid fa-arrow-left"></i> Back to ${state.selectionId ? 'Selection' : 'Catalogue'}</button><div class="grid grid-cols-1 md:grid-cols-2 gap-10 md:gap-16 items-start"><div><div class="aspect-square rounded-[2rem] overflow-hidden bg-gray-50 border border-gray-100 shadow-xl"><img src="${p.img}" id="main-detail-img" class="w-full h-full object-cover"></div><div class="thumb-grid"><div class="thumb-box active" onclick="switchImg('${p.img}', this)"><img src="${p.img}"></div>${p.img2 && p.img2 !== 'img/' ? `<div class="thumb-box" onclick="switchImg('${p.img2}', this)"><img src="${p.img2}"></div>` : ''}</div></div><div class="py-2"><span class="text-[9px] font-bold text-gray-300 tracking-[0.05em] uppercase mb-8 block">Boutique Selection</span><div class="space-y-12"><div><span class="detail-label">Item name:</span><h2 class="detail-product-name capitalize">${p.name}</h2></div><div><span class="detail-label">Price:</span><p class="detail-price-text">${p.price} AED</p></div><div class="h-px bg-gray-100 w-full"></div><div><span class="detail-label">Description:</span><p class="detail-description-text">${p.desc || 'Premium handcrafted selection curated specifically for our collection.'}</p></div></div><button onclick="inquireOnWhatsApp('${p.id}')" class="w-full bg-black text-white py-6 rounded-2xl font-bold text-[12px] uppercase tracking-widest shadow-2xl hover:scale-[1.02] transition-all mt-16 text-center">Inquire on WhatsApp</button></div></div></div>`;
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.saveProduct = async () => {
            const id = document.getElementById('edit-id').value;
            const btn = document.getElementById('p-save-btn');
            const data = { name: document.getElementById('p-name').value, price: document.getElementById('p-price').value, img: document.getElementById('p-img').value, img2: document.getElementById('p-img2').value, catId: document.getElementById('p-cat-id').value, desc: document.getElementById('p-desc').value, updatedAt: Date.now() };
            if (!data.name || !data.img) return showToast("Required info missing");
            btn.disabled = true; btn.innerText = "Syncing...";
            try { if (id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), data); else await addDoc(prodCol, data); showToast("Synced Successfully"); resetForm(); DATA.p = []; refreshData(); } 
            catch (e) { showToast("Save Error"); } finally { btn.disabled = false; btn.innerText = "Sync Product"; }
        };

        window.saveCategory = async () => {
            const name = document.getElementById('c-name').value;
            const img = document.getElementById('c-img').value;
            if (!name) return showToast("Name required");
            try { await addDoc(catCol, { name, img }); showToast("Category Added"); document.getElementById('c-name').value = ""; DATA.p = []; refreshData(); } 
            catch (e) { showToast("Category Error"); }
        };

        window.deleteProduct = async (id) => { if (!confirm("Are you sure?")) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id)); showToast("Deleted"); DATA.p = DATA.p.filter(x => x.id !== id); renderAdminUI(); renderHome(); } catch (e) { showToast("Delete Error"); } };
        window.deleteCategory = async (id) => { if (!confirm("Delete Category?")) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); showToast("Category Removed"); DATA.p = []; refreshData(); } catch (e) { showToast("Error"); } };

        window.toggleSelect = (e, id) => { e.stopPropagation(); if (state.selected.includes(id)) state.selected = state.selected.filter(x => x !== id); else state.selected.push(id); renderHome(); };

        function updateSelectionBar() {
            const bar = document.getElementById('selection-bar');
            const count = document.getElementById('selected-count');
            if (!bar) return;
            if (state.selected.length > 0 && !state.selectionId) { bar.style.display = 'flex'; bar.classList.add('animate-selection'); if (count) count.innerText = `${state.selected.length} items`; } 
            else { bar.style.display = 'none'; bar.classList.remove('animate-selection'); }
        }

        window.clearSelection = () => { state.selected = []; state.selectionId = null; renderHome(); };

        window.shareSelection = async () => {
            if (state.selected.length === 0) return;
            showToast("Generating link...");
            try { const docRef = await addDoc(shareCol, { ids: state.selected, createdAt: Date.now() }); const shareUrl = `${window.location.origin}${window.location.pathname}?s=${docRef.id}`; const textArea = document.createElement("textarea"); textArea.value = shareUrl; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); showToast("Secret Link Copied!"); } 
            catch (e) { showToast("Sharing failed."); }
        };

        window.sendBulkInquiry = () => {
            const items = state.selected.map(id => DATA.p.find(p => p.id === id)).filter(x => x);
            let msg = `*Hello Speed Gifts!*\nI am interested in these items:\n\n`;
            items.forEach((item, i) => { const pUrl = `${window.location.origin}${window.location.pathname}?p=${item.id}`; msg += `${i+1}. *${item.name}* - ${item.price} AED\nLink: ${pUrl}\n\n`; });
            window.open(`https://wa.me/919000000000?text=${encodeURIComponent(msg)}`);
        };

        window.inquireOnWhatsApp = (id) => {
            const p = DATA.p.find(x => x.id === id);
            const pUrl = `${window.location.origin}${window.location.pathname}?p=${p.id}`;
            const msg = `*Inquiry regarding:* ${p.name}\n*Price:* ${p.price} AED\n\n*Product Link:* ${pUrl}\n\nPlease let me know the availability.`;
            window.open(`https://wa.me/919000000000?text=${encodeURIComponent(msg)}`);
        };

        window.switchImg = (src, el) => { const main = document.getElementById('main-detail-img'); if (main) main.src = src; document.querySelectorAll('.thumb-box').forEach(x => x.classList.remove('active')); if (el) el.classList.add('active'); };

        function renderAdminUI() {
            const pList = document.getElementById('admin-product-list');
            const cList = document.getElementById('admin-category-list');
            if (!pList || !cList) return;
            pList.innerHTML = DATA.p.map(p => `<div class="flex items-center gap-5 p-5 bg-gray-50 rounded-[2rem] border border-gray-100 group"><img src="${p.img}" class="w-16 h-16 rounded-xl object-cover shadow-sm border-2 border-white"><div class="flex-1"><h4 class="font-bold text-[13px] capitalize">${p.name}</h4><p class="text-[10px] text-gray-400 font-bold">${p.price} AED</p></div><div class="flex gap-2"><button onclick="editProduct('${p.id}')" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-lg text-gray-400 hover:text-black transition-all"><i class="fa-solid fa-pen text-[10px]"></i></button><button onclick="deleteProduct('${p.id}')" class="w-10 h-10 flex items-center justify-center bg-red-50 rounded-full text-red-200 hover:text-red-500 transition-all"><i class="fa-solid fa-trash text-[10px]"></i></button></div></div>`).join('') || `<p class="text-center py-20 text-[11px] text-gray-300 italic">Inventory Empty</p>`;
            cList.innerHTML = DATA.c.map(c => `<div class="flex items-center gap-5 p-5 bg-gray-50 rounded-[2rem] border border-gray-100"><img src="${c.img}" class="w-14 h-14 rounded-full object-cover border-4 border-white shadow-sm" onerror="this.src='https://placehold.co/100x100?text=Icon'"><div class="flex-1 font-bold text-[13px] uppercase">${c.name}</div><button onclick="deleteCategory('${c.id}')" class="w-10 h-10 flex items-center justify-center bg-red-50 rounded-full text-red-200 hover:text-red-500 transition-all"><i class="fa-solid fa-trash text-[10px]"></i></button></div>`).join('') || `<p class="text-center py-20 text-[11px] text-gray-300 italic">No Categories</p>`;
        }

        window.applyFilter = (id) => { state.filter = id; renderHome(); };
        window.showAdminPanel = () => { document.getElementById('admin-panel').classList.remove('hidden'); document.body.style.overflow = 'hidden'; renderAdminUI(); };
        window.hideAdminPanel = () => { document.getElementById('admin-panel').classList.add('hidden'); document.body.style.overflow = 'auto'; };
        
        window.switchAdminTab = (tab) => {
            const isProd = tab === 'products';
            document.getElementById('admin-product-section').classList.toggle('hidden', !isProd);
            document.getElementById('admin-category-section').classList.toggle('hidden', isProd);
            document.getElementById('admin-product-list').classList.toggle('hidden', !isProd);
            document.getElementById('admin-category-list').classList.toggle('hidden', isProd);
            document.getElementById('tab-p').className = isProd ? "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase bg-white shadow-xl" : "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase text-gray-400";
            document.getElementById('tab-c').className = !isProd ? "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase bg-white shadow-xl" : "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase text-gray-400";
            document.getElementById('list-title').innerText = isProd ? "Live Inventory" : "Existing Categories";
        };

        function populateCatSelect() {
            const select = document.getElementById('p-cat-id');
            if (select) select.innerHTML = `<option value="">Category Selection</option>` + DATA.c.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        window.resetForm = () => {
            const fields = ['edit-id', 'p-name', 'p-price', 'p-desc'];
            fields.forEach(f => { const el = document.getElementById(f); if (el) el.value = ""; });
            document.getElementById('p-img').value = "img/"; document.getElementById('p-img2').value = "img/";
        };

        function showToast(msg) {
            const t = document.getElementById('toast'); if (!t) return;
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }

        startSync();
    </script>
</body>
</html>